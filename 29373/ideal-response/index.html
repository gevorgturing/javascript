<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Real-Time Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <style>
        body { font-family: 'Arial', sans-serif; padding: 50px; }
        canvas { width: 100%; height: 400px; }
        .order-item { cursor: pointer; transition: background-color 0.3s; }
        .order-item:hover { background-color: #f0f0f0; }
        .button-small {
            font-size: 0.8em;
            margin-left: 10px;
        }
        .input, .button {
            margin: 5px;
        }
        .input-field {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div id="userWelcome" class="notification is-info" style="display:none;">
        Welcome, <span id="userName"></span>! Your balance: $<span id="userBalance">10000</span>
    </div>
    <input id="userNameInput" type="text" placeholder="Enter your name" class="input mb-2">
    <button id="startApp" class="button is-primary mb-4">Start Tracking</button>
    <h1 class="title">Current BTC Price: $<span id="currentPrice">Loading...</span></h1>
    <div id="priceChart">
        <canvas id="priceChartCanvas"></canvas>
    </div>
    <div class="mt-4 input-field">
        <input id="orderPrice" type="number" placeholder="Order price" class="input">
        <input id="orderAmount" type="number" placeholder="Amount to buy" class="input">
        <button id="placeOrder" class="button is-link">Place Order</button>
    </div>
    <div id="ordersList" class="mt-4">
        <h2 class="title is-4">Your Orders</h2>
        <ul id="orders"></ul>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let userName, userBalance = 10000, btcBalance = 0, prices = [], orders = [];
    let priceChart; // Define this globally to ensure availability

    document.addEventListener('DOMContentLoaded', function () {
        setup();
    });

    function updateOrdersList() {
        const ordersList = document.getElementById('orders');
        ordersList.innerHTML = '';
        orders.forEach((order, index) => {
            let li = document.createElement('li');
            li.textContent = `Order at $${order.price} for ${order.amount} BTC - Status: ${order.status}`;
            li.classList.add('order-item');
            let editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.className = 'button button-small';
            editBtn.onclick = () => editOrder(index);
            let cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'button button-small';
            cancelBtn.onclick = () => cancelOrder(index);
            li.appendChild(editBtn);
            li.appendChild(cancelBtn);
            ordersList.appendChild(li);
        });
    }

    function setup() {
        document.getElementById('startApp').onclick = initializeUser;
        loadUserData();
        createChart();
        updatePrice();
        setInterval(updatePrice, 10000);
    }

    function initializeUser() {
        userName = document.getElementById('userNameInput').value;
        if(userName) {
            saveUserData();
            document.getElementById('userWelcome').style.display = 'block';
            document.getElementById('userName').textContent = userName;
            document.getElementById('userBalance').textContent = parseFloat(userBalance).toFixed(2);
            document.getElementById('userNameInput').style.display = 'none';
            document.getElementById('startApp').style.display = 'none';
        }
    }

    function loadUserData() {
        let storedUser = localStorage.getItem('user');
        if(storedUser) {
            let user = JSON.parse(storedUser);
            userName = user.name;
            userBalance = user.balance;
            document.getElementById('userWelcome').style.display = 'block';
            document.getElementById('userName').textContent = userName;
            document.getElementById('userBalance').textContent = parseFloat(userBalance).toFixed(2);
        }

        let storedPrices = localStorage.getItem('prices');
        prices = storedPrices ? JSON.parse(storedPrices) : [];
        let storedOrders = localStorage.getItem('orders');
        orders = storedOrders ? JSON.parse(storedOrders) : [];
        updateOrdersList();
    }

    function saveUserData() {
        localStorage.setItem('user', JSON.stringify({name: userName, balance: userBalance}));
    }

    function updatePrice() {
        const lastPrice = prices.length ? prices[prices.length - 1] : 20000; // Default start price if empty
        const fluctuation = 0.1; // 10% fluctuation
        const maxChange = lastPrice * fluctuation;
        const price = Math.round((lastPrice + maxChange * (2 * Math.random() - 1)) * 100) / 100;
        document.getElementById('currentPrice').textContent = price;
        prices.push(price);
        if(prices.length > 100) prices.shift();
        localStorage.setItem('prices', JSON.stringify(prices));
        updateChart();
    }

    function createChart() {
        const ctx = document.getElementById('priceChartCanvas').getContext('2d');
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: prices.map((_, i) => i),
                datasets: [{
                    label: 'BTC Price',
                    data: prices,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            }
        });
    }

    function updateChart() {
        if (priceChart && priceChart.data) {
            priceChart.data.labels = prices.map((_, i) => i);
            priceChart.data.datasets[0].data = prices;
            priceChart.update();
        }
    }

    function placeOrder() {
        const orderPrice = parseFloat(document.getElementById('orderPrice').value);
        const orderAmount = parseFloat(document.getElementById('orderAmount').value);

        if (!orderPrice || !orderAmount) {
            alert('Please enter valid price and amount.');
            return;
        }

        const totalCost = orderPrice * orderAmount;
        if (userBalance < totalCost) {
            alert('Insufficient balance to place this order.');
            return;
        }

        userBalance -= totalCost;
        document.getElementById('userBalance').textContent = userBalance.toFixed(2);

        orders.push({
            price: orderPrice,
            amount: orderAmount,
            status: 'Pending'
        });

        localStorage.setItem('orders', JSON.stringify(orders));
        updateOrdersList();
        alert('Order placed successfully.');

        // Clear inputs after placing an order
        document.getElementById('orderPrice').value = '';
        document.getElementById('orderAmount').value = '';
    }

    function editOrder(index) {
        let order = orders[index];
        let priceInput = prompt('Enter new price for the order:', order.price);
        let amountInput = prompt('Enter new amount for the order:', order.amount);

        if (!priceInput || !amountInput || isNaN(parseFloat(priceInput)) || isNaN(parseFloat(amountInput))) {
            alert('Invalid input values.');
            return;
        }

        let newPrice = parseFloat(priceInput);
        let newAmount = parseFloat(amountInput);
        if (newPrice !== order.price || newAmount !== order.amount) {
            let originalCost = order.price * order.amount;
            let newCost = newPrice * newAmount;
            if (newCost > originalCost && userBalance < (newCost - originalCost)) {
                alert('Insufficient balance to update the order.');
                return;
            }

            userBalance += originalCost - newCost;
            document.getElementById('userBalance').textContent = userBalance.toFixed(2);

            order.price = newPrice;
            order.amount = newAmount;
            localStorage.setItem('orders', JSON.stringify(orders));
            updateOrdersList();
        }
    }

    function cancelOrder(index) {
        let order = orders[index];
        if (order.status === 'Pending') {
            let refund = order.price * order.amount;
            userBalance += refund;
            document.getElementById('userBalance').textContent = userBalance.toFixed(2);
            orders.splice(index, 1);
            localStorage.setItem('orders', JSON.stringify(orders));
            updateOrdersList();
            alert('Order canceled and balance refunded.');
        } else {
            alert('Cannot cancel executed orders.');
        }
    }

    document.getElementById('placeOrder').onclick = placeOrder;
</script>
</body>
</html>
